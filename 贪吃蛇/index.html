<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è´ªåƒè›‡ â€” Canvas å¥½ç©ç‰ˆ</title>
<style>
  :root{
    --bg:#0f1724; --panel:#0b1220; --accent:#ffd166; --muted:#9aa6b2;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071127 0%,#071019 60%);font-family:Inter,Segoe UI,Helvetica,Arial;}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;}
  .game{
    display:grid;grid-template-columns:1fr 320px;gap:20px;align-items:start;width:min(1100px,98vw);
  }
  canvas{background:
    radial-gradient(ellipse at 20% 10%, rgba(255,255,255,0.02), transparent 20%),
    linear-gradient(180deg, rgba(255,255,255,0.01), transparent),
    #071125;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);width:100%;height:auto;display:block;}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:12px;color:#e6eef6}
  h1{margin:0 0 10px;font-size:20px;color:var(--accent)}
  .stat{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
  .stat div{display:flex;justify-content:space-between;color:var(--muted);font-size:14px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.01)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  button{background:linear-gradient(180deg,#142033,#0d1622);color:#e6eef6;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .small{font-size:13px;padding:6px 8px}
  footer{color:var(--muted);font-size:13px;margin-top:8px}
  .overlay{position:absolute;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .msg{pointer-events:auto;background:rgba(3,8,18,0.7);padding:18px 20px;border-radius:10px;color:#fff;text-align:center}
  @media(max-width:880px){ .game{grid-template-columns:1fr; } .panel{order:2} }
</style>
</head>
<body>
<div class="wrap">
  <div class="game">
    <div style="position:relative;">
      <canvas id="c" width="600" height="600"></canvas>
      <div id="overlay" class="overlay" style="display:none"><div class="msg" id="msg"></div></div>
    </div>
    <div class="panel">
      <h1>è´ªåƒè›‡ â€” Canvas å¥½ç©ç‰ˆ ğŸ</h1>
      <div class="stat">
        <div><span>å¾—åˆ†</span><strong id="score">0</strong></div>
        <div><span>æœ€é«˜åˆ†</span><strong id="best">0</strong></div>
        <div><span>é€Ÿåº¦</span><strong id="speedLabel">Normal</strong></div>
        <div><span>å…³å¡</span><strong id="level">1</strong></div>
      </div>
      <div style="color:var(--muted);font-size:14px">è®¾ç½®</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnWrap" class="small">ç©¿å¢™ï¼šå¼€</button>
        <button id="btnReset" class="small">é‡ç½® (R)</button>
        <button id="btnPause" class="small">æš‚åœ (ç©ºæ ¼)</button>
      </div>
      <div class="controls" style="margin-top:12px">
        <button id="btnEasy">å®¹æ˜“</button>
        <button id="btnNormal">æ™®é€š</button>
        <button id="btnHard">å›°éš¾</button>
      </div>
      <footer>
        <div>æ–¹å‘é”® / WASD æ§åˆ¶ï¼Œç§»åŠ¨è®¾å¤‡æ»‘åŠ¨æ”¯æŒã€‚</div>
        <div style="margin-top:8px">é‡‘è‹¹æœä¼šçŸ­æš‚åŠ é€Ÿå¹¶åŠ å€å¾—åˆ† âœ¨</div>
      </footer>
    </div>
  </div>
</div>

<script>
(() => {
  // === åŸºæœ¬å‚æ•° ===
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const grid = 20;
  const cols = W / grid, rows = H / grid;

  // UI å…ƒç´ 
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const levelEl = document.getElementById('level');
  const speedLabel = document.getElementById('speedLabel');
  const overlay = document.getElementById('overlay');
  const msg = document.getElementById('msg');

  // æ¸¸æˆå˜é‡
  let snake = [{x: Math.floor(cols/2), y: Math.floor(rows/2)}];
  let dir = {x:1,y:0}, nextDir = null;
  let apple = null, golden = null;
  let obstacles = [];
  let particles = [];
  let score=0, best=+localStorage.getItem('snake_best') || 0;
  let speed = 8; // ticks per second
  let tickAcc = 0;
  let wrap = true;
  let paused = false;
  let running = false;
  let level = 1;
  let tickInterval = 1000 / speed;
  let goldenTimer = 0;

  bestEl.textContent = best;

  // å£°éŸ³ï¼ˆç®€æ˜“ï¼‰
  const audioCtx = window.AudioContext ? new AudioContext() : null;
  function beep(freq=200,dur=0.06,vol=0.02){
    if(!audioCtx) return;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine';o.frequency.value=freq;
    g.gain.value=vol;
    o.connect(g);g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+dur);
  }

  // å·¥å…·
  const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const same = (a,b)=>a.x===b.x && a.y===b.y;
  function placeApple(isGolden=false){
    let tries=0;
    while(tries<1000){
      const x = randInt(0,cols-1), y = randInt(0,rows-1);
      if(snake.some(s=>s.x===x && s.y===y)) { tries++; continue;}
      if(obstacles.some(o=>o.x===x && o.y===y)) { tries++; continue;}
      if(apple && apple.x===x && apple.y===y) { tries++; continue;}
      if(golden && golden.x===x && golden.y===y) { tries++; continue;}
      if(isGolden) golden = {x,y,dur: randInt(6,10)*1000};
      else apple = {x,y};
      return;
    }
  }

  // åˆå§‹åŒ–
  function reset(full=true){
    snake = [{x: Math.floor(cols/2), y: Math.floor(rows/2)}];
    dir = {x:1,y:0}; nextDir=null;
    apple=null; golden=null; obstacles=[];
    score = 0; level = 1; speed = 8;
    tickInterval = 1000 / speed;
    running = true;
    paused = false;
    placeApple();
    placeGoldChance();
    overlay.style.display = 'none';
    updateUI();
  }

  function updateUI(){
    scoreEl.textContent = score;
    bestEl.textContent = best;
    levelEl.textContent = level;
    speedLabel.textContent = speed < 10 ? 'æ…¢' : (speed < 14 ? 'æ™®é€š' : 'å¿«');
  }

  // ç”Ÿæˆéšœç¢ï¼ˆéšç€ç­‰çº§ï¼‰
  function genObstacles(){
    obstacles = [];
    const count = Math.min(6, Math.floor((level-1)/1.2));
    for(let i=0;i<count;i++){
      placeOneObstacle();
    }
  }
  function placeOneObstacle(){
    let tries=0;
    while(tries<1000){
      const x = randInt(2,cols-3), y = randInt(2,rows-3);
      if(snake.some(s=>s.x===x && s.y===y)) { tries++; continue;}
      if(obstacles.some(o=>o.x===x && o.y===y)) { tries++; continue;}
      if(apple && apple.x===x && apple.y===y) { tries++; continue;}
      obstacles.push({x,y}); return;
    }
  }

  // ç§»åŠ¨é€»è¾‘
  function tick(){
    if(!running || paused) return;
    if(nextDir){
      // ç¦æ­¢ç›´æ¥åå‘
      if(!(nextDir.x === -dir.x && nextDir.y === -dir.y)) dir = nextDir;
      nextDir = null;
    }
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

    if(wrap){
      head.x = (head.x + cols) % cols;
      head.y = (head.y + rows) % rows;
    } else {
      if(head.x < 0 || head.x >= cols || head.y < 0 || head.y >= rows){
        return gameOver();
      }
    }

    // ç¢°æ’è‡ªèº«æˆ–éšœç¢
    if(snake.some(s=>s.x===head.x && s.y===head.y) || obstacles.some(o=>o.x===head.x && o.y===head.y)){
      return gameOver();
    }

    snake.unshift(head);

    // åƒè‹¹æœ
    if(apple && head.x===apple.x && head.y===apple.y){
      score += 10;
      spawnEatParticles(head, 'apple');
      beep(400,0.08,0.04);
      apple = null;
      placeApple();
      maybeSpawnGolden();
      if(score % 50 === 0){
        level++;
        genObstacles();
        speed = Math.min(16, speed + 1);
        tickInterval = 1000 / speed;
      }
    } else if(golden && head.x===golden.x && head.y===golden.y){
      score += 30;
      spawnEatParticles(head, 'gold');
      beep(700,0.12,0.06);
      golden = null;
      // æš‚æ—¶åŠ é€Ÿ
      const old = speed;
      speed = Math.min(20, speed + 4);
      setTimeout(()=>{ speed = old; tickInterval = 1000 / speed; }, 1800);
    } else {
      snake.pop();
    }
    tickInterval = 1000 / speed;
    updateUI();
    // éšæœºé‡‘è‹¹æœè®¡æ—¶å‡å°‘
    if(golden){
      golden.dur -= tickInterval;
      if(golden.dur <= 0) golden = null;
    }
  }

  function gameOver(){
    running = false;
    overlay.style.display='flex';
    msg.innerHTML = `<strong>æ¸¸æˆç»“æŸ</strong><div style="margin-top:8px">å¾—åˆ† ${score}</div><div style="margin-top:8px;font-size:13px;color:#acc">æŒ‰ R é‡ç©</div>`;
    beep(120,0.3,0.06);
    if(score>best){ best=score; localStorage.setItem('snake_best', best); bestEl.textContent = best; }
  }

  // ç²’å­æ•ˆæœ
  function spawnEatParticles(pos, type='apple'){
    const color = type==='gold' ? '#ffd166' : '#60a5fa';
    for(let i=0;i<18;i++){
      particles.push({
        x: pos.x + 0.5, y: pos.y + 0.5,
        vx: (Math.random()-0.5)*2.4, vy: (Math.random()-0.8)*2.4,
        life: randInt(18,36), col: color
      });
    }
  }

  function updateParticles(){
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx * 0.08;
      p.y += p.vy * 0.08;
      p.vy += 0.02;
      p.life--;
      if(p.life<=0) particles.splice(i,1);
    }
  }

  // ç”»é¢æ¸²æŸ“
  function draw(){
    ctx.clearRect(0,0,W,H);
    // èƒŒæ™¯æ ¼
    ctx.fillStyle = '#071225';
    ctx.fillRect(0,0,W,H);

    // ç»˜åˆ¶ç½‘æ ¼ï¼ˆè½»å¾®ï¼‰
    ctx.strokeStyle = 'rgba(255,255,255,0.02)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let x=0;x<=cols;x++){ ctx.moveTo(x*grid,0); ctx.lineTo(x*grid,H); }
    for(let y=0;y<=rows;y++){ ctx.moveTo(0,y*grid); ctx.lineTo(W,y*grid); }
    ctx.stroke();

    // éšœç¢
    ctx.fillStyle = '#334155';
    obstacles.forEach(o=>{
      roundBox(o.x*grid, o.y*grid, grid, grid, 6);
    });

    // è‹¹æœ
    if(apple){
      drawApple(apple.x, apple.y, false);
    }
    if(golden){
      drawApple(golden.x, golden.y, true);
    }

    // è›‡ - æ¸å˜
    for(let i=snake.length-1;i>=0;i--){
      const s = snake[i];
      const t = i/snake.length;
      const hue = 200 - 40*t;
      const alpha = 0.9 - 0.7*t;
      ctx.fillStyle = `rgba(96,165,250,${alpha})`;
      ctx.strokeStyle = `rgba(8,12,24,0.12)`;
      roundBox(s.x*grid, s.y*grid, grid, grid, 6);
    }
    // ç”»å¤´ï¼ˆåŠ é«˜å…‰ï¼‰
    if(snake.length){
      const h = snake[0];
      ctx.fillStyle = '#ffffff20';
      ctx.beginPath();
      ctx.arc(h.x*grid + grid*0.5, h.y*grid + grid*0.5, grid*0.22, 0, 2*Math.PI);
      ctx.fill();
    }

    // ç²’å­
    particles.forEach(p=>{
      ctx.fillStyle = p.col;
      ctx.globalAlpha = Math.max(0, p.life/36);
      ctx.fillRect(p.x*grid, p.y*grid, 2.4, 2.4);
      ctx.globalAlpha = 1;
    });

    // HUD å°æç¤º
    if(!running){
      // draw overlay handled separately
    }
  }

  function drawApple(x,y, gold=false){
    const px = x*grid, py = y*grid;
    const r = grid*0.42;
    ctx.save();
    ctx.translate(px+grid/2, py+grid/2);
    // shadow
    ctx.fillStyle = gold ? '#b47b00' : '#8b0000';
    ctx.beginPath(); ctx.ellipse(0,0,r,r,0,0,2*Math.PI); ctx.fill();
    // shine
    ctx.fillStyle = gold ? '#ffea9a' : '#ff8b8b';
    ctx.beginPath(); ctx.ellipse(-r*0.26, -r*0.36, r*0.28, r*0.22,0,0,2*Math.PI); ctx.fill();
    // stem
    ctx.fillStyle = '#2f855a';
    ctx.fillRect(-2, -r-4, 4, 8);
    // highlight
    if(gold){
      ctx.globalCompositeOperation='lighter';
      ctx.fillStyle='rgba(255,240,160,0.25)';
      ctx.beginPath(); ctx.ellipse(r*0.1, -r*0.4, r*0.45, r*0.25, 0, 0, 2*Math.PI); ctx.fill();
      ctx.globalCompositeOperation='source-over';
    }
    ctx.restore();
  }

  function roundBox(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.fill();
    ctx.stroke();
  }

  // é‡‘è‹¹æœç”Ÿæˆæ¦‚ç‡
  function maybeSpawnGolden(){
    if(golden) return;
    if(Math.random() < 0.18){
      placeApple(true);
    }
  }
  // å‘¨æœŸæ€§äº§ç”Ÿé‡‘è‹¹æœ
  function placeGoldChance(){
    setTimeout(()=>{
      if(!golden && Math.random() < 0.5) placeApple(true);
      placeGoldChance();
    }, randInt(7000,14000));
  }

  // ä¸»å¾ªç¯ï¼ˆåŠ¨ç”» + é€»è¾‘èŠ‚æ‹ï¼‰
  let last = performance.now();
  function loop(now){
    const dt = now - last;
    last = now;
    tickAcc += dt;
    // æ‰§è¡Œ tickï¼ˆåŸºäº speedï¼‰
    while(tickAcc >= tickInterval){
      tick();
      tickAcc -= tickInterval;
    }
    updateParticles();
    draw();
    requestAnimationFrame(loop);
  }

  // æ§åˆ¶è¾“å…¥
  document.addEventListener('keydown', e=>{
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d'].includes(e.key)){
      if(e.key === 'ArrowUp' || e.key === 'w') nextDir={x:0,y:-1};
      if(e.key === 'ArrowDown' || e.key === 's') nextDir={x:0,y:1};
      if(e.key === 'ArrowLeft' || e.key === 'a') nextDir={x:-1,y:0};
      if(e.key === 'ArrowRight' || e.key === 'd') nextDir={x:1,y:0};
    } else if(e.key === ' '){
      paused = !paused;
      document.getElementById('btnPause').textContent = paused ? 'ç»§ç»­' : 'æš‚åœ (ç©ºæ ¼)';
    } else if(e.key === 'r' || e.key === 'R'){
      reset();
    }
  });

  // è§¦æ‘¸æ»‘åŠ¨
  (function touchControls(){
    let x0=0,y0=0;
    canvas.addEventListener('touchstart', e=>{
      const t = e.touches[0];
      x0 = t.clientX; y0 = t.clientY;
    });
    canvas.addEventListener('touchend', e=>{
      const t = e.changedTouches[0];
      const dx = t.clientX - x0, dy = t.clientY - y0;
      if(Math.abs(dx) > Math.abs(dy)){
        if(dx>20) nextDir={x:1,y:0};
        else if(dx<-20) nextDir={x:-1,y:0};
      } else {
        if(dy>20) nextDir={x:0,y:1};
        else if(dy<-20) nextDir={x:0,y:-1};
      }
    });
  })();

  // UI æŒ‰é’®
  document.getElementById('btnWrap').addEventListener('click', e=>{
    wrap = !wrap;
    e.target.textContent = `ç©¿å¢™ï¼š${wrap ? 'å¼€' : 'å…³'}`;
  });
  document.getElementById('btnReset').addEventListener('click', reset);
  document.getElementById('btnPause').addEventListener('click', e=>{
    paused = !paused; e.target.textContent = paused ? 'ç»§ç»­' : 'æš‚åœ (ç©ºæ ¼)';
  });
  document.getElementById('btnEasy').addEventListener('click', ()=>{ speed=6; reset(); });
  document.getElementById('btnNormal').addEventListener('click', ()=>{ speed=8; reset(); });
  document.getElementById('btnHard').addEventListener('click', ()=>{ speed=12; reset(); });

  // å¯åŠ¨
  reset();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>